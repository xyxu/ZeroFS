
# ZeroFS Optimized Aliyun OSS Configuration
# This configuration includes performance optimizations for better OSS performance

[cache]
dir = "${HOME}/.cache/zerofs"
disk_size_gb = 20.0  # Increased cache size for better performance
memory_size_gb = 2.0  # Increased memory cache

[storage]
url = "oss://my-bucket/zerofs-data"
encryption_password = "${ZEROFS_PASSWORD}"

[servers]
nfs = { addresses = ["127.0.0.1:2049"] }
ninep = { addresses = ["127.0.0.1:5564"], unix_socket = "/tmp/zerofs.9p.sock" }
nbd = { addresses = ["127.0.0.1:10809"], unix_socket = "/tmp/zerofs.nbd.sock" }
rpc = { addresses = ["127.0.0.1:7000"], unix_socket = "/tmp/zerofs.rpc.sock" }

# Aliyun OSS configuration with performance optimizations
[oss]
access_key_id = "${OSS_ACCESS_KEY_ID}"
access_key_secret = "${OSS_ACCESS_KEY_SECRET}"
# Optional: endpoint will be auto-detected from URL, but can be overridden
# endpoint = "https://oss-cn-hangzhou.aliyuncs.com"

# Performance optimization settings
http_client_timeout = 60           # HTTP client timeout in seconds (default: 60)
http_client_connect_timeout = 30   # Connection timeout in seconds (default: 30)
http_client_pool_idle_timeout = 90 # Connection pool idle timeout (default: 90)
http_client_pool_max_idle_per_host = 10 # Max idle connections per host (default: 10)
http_client_allow_http = false     # Allow HTTP (not recommended for production)
enable_virtual_host_style = true   # Enable virtual host style (recommended)

# Retry strategy (when supported)
# retry_max_times = 3              # Maximum number of retries
# retry_factor = 2.0               # Exponential backoff factor
# retry_max_delay = 60             # Maximum delay between retries in seconds
# retry_jitter = true              # Add jitter to retry delays

# Optional LSM tree tuning for better performance
[lsm]
l0_max_ssts = 32                   # Increased from default 16 for better write performance
max_unflushed_gb = 2.0             # Increased from default 1.0 GB
max_concurrent_compactions = 16    # Increased from default 8 for faster compactions
flush_interval_secs = 60           # Increased from default 30 seconds for less frequent flushes

# Optional filesystem quota
[filesystem]
max_size_gb = 1000.0               # Limit filesystem to 1 TB

# ============================================================================
# Performance Tuning Recommendations:
# ============================================================================
# 1. Connection Pooling:
#    - http_client_pool_max_idle_per_host: Set based on expected concurrent connections
#    - Typical values: 10-50 for moderate load, 100+ for high concurrency
#
# 2. Timeout Settings:
#    - http_client_timeout: Should be >= typical request time + network latency
#    - http_client_connect_timeout: Should account for network conditions
#
# 3. Cache Sizing:
#    - disk_size_gb: Should be large enough to hold working set
#    - memory_size_gb: More memory = better performance, but consider system RAM
#
# 4. LSM Tuning:
#    - max_concurrent_compactions: Higher values improve throughput but use more CPU
#    - l0_max_ssts: Higher values reduce compaction frequency but increase read amplification
#
# 5. For production use:
#    - Monitor OSS metrics (request latency, error rates)
#    - Adjust timeouts based on observed performance
#    - Consider enabling retry when the feature becomes available
